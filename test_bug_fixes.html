<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bug修复测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #0f0f23;
            color: white;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #4ecdc4;
            border-radius: 5px;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 3px;
        }
        .pass {
            background-color: #2d5a2d;
            border-left: 4px solid #4caf50;
        }
        .info {
            background-color: #2d4a5a;
            border-left: 4px solid #2196f3;
        }
        .warning {
            background-color: #5a4a2d;
            border-left: 4px solid #ff9800;
        }
        .error {
            background-color: #5a2d2d;
            border-left: 4px solid #f44336;
        }
        button {
            background-color: #4ecdc4;
            color: #0f0f23;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #45b7b8;
        }
        #log {
            background-color: #1a1a1a;
            padding: 10px;
            border-radius: 5px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .fix-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        .fix-card {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid #4ecdc4;
            border-radius: 8px;
            padding: 15px;
        }
        .fix-card h3 {
            color: #4ecdc4;
            margin-bottom: 10px;
        }
        .fix-item {
            margin: 5px 0;
            font-size: 14px;
        }
        .canvas-check { border-color: #4caf50; }
        .ui-check { border-color: #ff9800; }
        .monster-logic { border-color: #f44336; }
        .error-handling { border-color: #2196f3; }
    </style>
</head>
<body>
    <h1>🐛 Bug修复测试</h1>
    
    <div class="test-section">
        <h2>📋 修复的Bug总结</h2>
        <div class="fix-summary">
            <div class="fix-card canvas-check">
                <h3>🎯 Canvas元素检查</h3>
                <div class="fix-item">✅ 问题: 构造函数中未检查Canvas元素是否存在</div>
                <div class="fix-item">✅ 修复: 添加null检查和错误抛出</div>
                <div class="fix-item">✅ 影响: 防止运行时错误</div>
            </div>
            <div class="fix-card ui-check">
                <h3>🖥️ UI元素检查</h3>
                <div class="fix-item">✅ 问题: UI管理器未检查DOM元素是否存在</div>
                <div class="fix-item">✅ 修复: 添加缺失元素警告</div>
                <div class="fix-item">✅ 影响: 提高调试能力</div>
            </div>
            <div class="fix-card monster-logic">
                <h3>👹 怪物生成逻辑</h3>
                <div class="fix-item">✅ 问题: expectedMonstersAtThisPoint变量未使用</div>
                <div class="fix-item">✅ 修复: 添加均匀分布检查</div>
                <div class="fix-item">✅ 影响: 确保怪物均匀分布</div>
            </div>
            <div class="fix-card error-handling">
                <h3>⚠️ 错误处理改进</h3>
                <div class="fix-item">✅ 问题: 缺少关键错误处理</div>
                <div class="fix-item">✅ 修复: 添加null检查和错误抛出</div>
                <div class="fix-item">✅ 影响: 提高代码健壮性</div>
            </div>
        </div>
    </div>

    <div class="test-section">
        <h2>🧪 测试功能</h2>
        <button onclick="testCanvasElement()">测试Canvas元素检查</button>
        <button onclick="testUIElements()">测试UI元素检查</button>
        <button onclick="testMonsterLogic()">测试怪物生成逻辑</button>
        <button onclick="testErrorHandling()">测试错误处理</button>
        <button onclick="testGameInitialization()">测试游戏初始化</button>
        <button onclick="clearLog()">清空日志</button>
    </div>

    <div class="test-section">
        <h2>📊 测试结果</h2>
        <div id="results"></div>
    </div>

    <div class="test-section">
        <h2>📝 测试日志</h2>
        <div id="log"></div>
    </div>

    <script>
        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}<br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
            document.getElementById('results').innerHTML = '';
        }

        function addResult(type, title, message) {
            const results = document.getElementById('results');
            const timestamp = new Date().toLocaleTimeString();
            results.innerHTML += `
                <div class="test-result ${type}">
                    <strong>[${timestamp}] ${title}</strong><br>
                    ${message}
                </div>
            `;
        }

        function testCanvasElement() {
            log('🎯 开始测试Canvas元素检查...');
            
            // 测试Canvas元素存在的情况
            const canvas = document.getElementById('gameCanvas');
            if (canvas) {
                log('✅ Canvas元素存在');
                
                // 测试获取2D上下文
                try {
                    const ctx = canvas.getContext('2d');
                    if (ctx) {
                        log('✅ 成功获取2D上下文');
                        addResult('pass', 'Canvas元素检查', 'Canvas元素和2D上下文都正常');
                    } else {
                        log('❌ 无法获取2D上下文');
                        addResult('error', 'Canvas元素检查', '无法获取2D上下文');
                    }
                } catch (error) {
                    log(`❌ 获取2D上下文失败: ${error.message}`);
                    addResult('error', 'Canvas元素检查', `获取2D上下文失败: ${error.message}`);
                }
            } else {
                log('❌ Canvas元素不存在');
                addResult('error', 'Canvas元素检查', 'Canvas元素不存在');
            }
        }

        function testUIElements() {
            log('🖥️ 开始测试UI元素检查...');
            
            const requiredElements = [
                'healthFill', 'healthText', 'scoreValue', 'levelValue', 
                'timeValue', 'progressValue', 'progressFill'
            ];
            
            const missingElements = [];
            const existingElements = [];
            
            requiredElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    existingElements.push(id);
                    log(`✅ UI元素存在: ${id}`);
                } else {
                    missingElements.push(id);
                    log(`❌ UI元素缺失: ${id}`);
                }
            });
            
            if (missingElements.length === 0) {
                log('✅ 所有必要的UI元素都存在');
                addResult('pass', 'UI元素检查', '所有必要的UI元素都存在');
            } else {
                log(`⚠️ 缺少${missingElements.length}个UI元素: ${missingElements.join(', ')}`);
                addResult('warning', 'UI元素检查', `缺少${missingElements.length}个UI元素: ${missingElements.join(', ')}`);
            }
        }

        function testMonsterLogic() {
            log('👹 开始测试怪物生成逻辑...');
            
            // 模拟怪物生成逻辑测试
            const levelConfig = {
                TOTAL_MONSTERS: 26,
                MAX_BARREL_MONSTERS: 15,
                MAX_UFO_TURRETS: 8,
                MAX_GIANT_MELEES: 3
            };
            
            const spawnPoints = 10;
            let barrelCount = 0;
            let ufoCount = 0;
            let giantCount = 0;
            
            log(`关卡配置: 总怪物${levelConfig.TOTAL_MONSTERS}个`);
            log(`生成点数量: ${spawnPoints}个`);
            
            // 测试均匀分布逻辑
            for (let i = 0; i < spawnPoints; i++) {
                const expectedMonstersAtThisPoint = Math.floor((i / spawnPoints) * levelConfig.TOTAL_MONSTERS);
                const monstersGeneratedSoFar = barrelCount + ufoCount + giantCount;
                const remainingMonsters = levelConfig.TOTAL_MONSTERS - monstersGeneratedSoFar;
                
                log(`生成点${i}: 期望${expectedMonstersAtThisPoint}个, 已生成${monstersGeneratedSoFar}个, 剩余${remainingMonsters}个`);
                
                // 模拟生成怪物
                if (remainingMonsters > 0 && monstersGeneratedSoFar < expectedMonstersAtThisPoint) {
                    const generated = Math.min(2, Math.max(1, Math.floor(Math.random() * 2) + 1));
                    barrelCount += generated;
                    log(`  生成${generated}个怪物`);
                } else {
                    log(`  跳过生成点`);
                }
            }
            
            const totalGenerated = barrelCount + ufoCount + giantCount;
            log(`总生成怪物数: ${totalGenerated}/${levelConfig.TOTAL_MONSTERS}`);
            
            if (totalGenerated <= levelConfig.TOTAL_MONSTERS) {
                log('✅ 怪物生成逻辑正确');
                addResult('pass', '怪物生成逻辑', '怪物生成逻辑正确，数量控制良好');
            } else {
                log('❌ 怪物生成数量超出限制');
                addResult('error', '怪物生成逻辑', '怪物生成数量超出限制');
            }
        }

        function testErrorHandling() {
            log('⚠️ 开始测试错误处理...');
            
            // 测试错误处理机制
            const testCases = [
                {
                    name: 'Canvas元素不存在',
                    test: () => {
                        const fakeCanvas = document.getElementById('nonExistentCanvas');
                        if (!fakeCanvas) {
                            throw new Error('Canvas element with id "nonExistentCanvas" not found');
                        }
                    }
                },
                {
                    name: '2D上下文获取失败',
                    test: () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        if (!ctx) {
                            throw new Error('Failed to get 2D context from canvas');
                        }
                    }
                },
                {
                    name: 'UI元素缺失检查',
                    test: () => {
                        const missingElements = ['nonExistent1', 'nonExistent2'];
                        const found = missingElements.filter(id => document.getElementById(id));
                        if (found.length > 0) {
                            throw new Error('Unexpected elements found');
                        }
                    }
                }
            ];
            
            let passedTests = 0;
            let totalTests = testCases.length;
            
            testCases.forEach(testCase => {
                try {
                    testCase.test();
                    log(`✅ ${testCase.name}: 测试通过`);
                    passedTests++;
                } catch (error) {
                    log(`❌ ${testCase.name}: ${error.message}`);
                }
            });
            
            log(`错误处理测试结果: ${passedTests}/${totalTests} 通过`);
            
            if (passedTests === totalTests) {
                addResult('pass', '错误处理测试', '所有错误处理测试通过');
            } else {
                addResult('warning', '错误处理测试', `${passedTests}/${totalTests} 测试通过`);
            }
        }

        function testGameInitialization() {
            log('🎮 开始测试游戏初始化...');
            
            // 检查游戏初始化所需的关键组件
            const components = [
                { name: 'Canvas元素', check: () => document.getElementById('gameCanvas') },
                { name: '配置对象', check: () => typeof CONFIG !== 'undefined' },
                { name: '游戏引擎类', check: () => typeof GameEngine !== 'undefined' },
                { name: '输入管理器', check: () => typeof InputManager !== 'undefined' },
                { name: 'UI管理器', check: () => typeof UIManager !== 'undefined' },
                { name: '图片加载器', check: () => typeof ImageLoader !== 'undefined' },
                { name: '音频管理器', check: () => typeof AudioManager !== 'undefined' },
                { name: '摄像机类', check: () => typeof Camera !== 'undefined' }
            ];
            
            let availableComponents = 0;
            let totalComponents = components.length;
            
            components.forEach(component => {
                try {
                    const result = component.check();
                    if (result) {
                        log(`✅ ${component.name}: 可用`);
                        availableComponents++;
                    } else {
                        log(`❌ ${component.name}: 不可用`);
                    }
                } catch (error) {
                    log(`❌ ${component.name}: 错误 - ${error.message}`);
                }
            });
            
            log(`游戏组件检查结果: ${availableComponents}/${totalComponents} 可用`);
            
            if (availableComponents === totalComponents) {
                addResult('pass', '游戏初始化测试', '所有游戏组件都可用');
            } else {
                addResult('warning', '游戏初始化测试', `${availableComponents}/${totalComponents} 组件可用`);
            }
        }

        // 页面加载时自动运行测试
        window.onload = function() {
            log('🐛 Bug修复测试页面加载完成');
            log('点击按钮开始测试...');
        };
    </script>
</body>
</html>




