# 末日垃圾场游戏 (Doomsday Junkyard Game)

## 项目概述

这是一个基于HTML5 Canvas的末日主题射击游戏，玩家控制主角在垃圾场中向上移动，消灭怪物，完成关卡挑战。

## 技术架构

### 核心文件结构
```
├── index.html          # 主页面
├── styles.css          # 样式文件
├── config.js           # 游戏配置
├── gameObjects.js      # 游戏对象类
├── gameEngine.js       # 游戏引擎
├── inputHandler.js     # 输入处理
├── uiManager.js        # UI管理
├── imageLoader.js      # 图片加载器
├── audioManager.js     # 音频管理
├── camera.js           # 摄像机系统
└── src/                # 美术资源文件夹
    ├── player_walk_01~04.png  # 主角动画帧
    ├── monster_01~03.png      # 怪物静态图
    ├── bg_road_01~05.png      # 背景循环图
    └── 末日垃圾场.m4a         # BGM音乐
```

### 技术栈
- **HTML5 Canvas**: 游戏渲染
- **JavaScript ES6+**: 游戏逻辑
- **Web Audio API**: 音频播放
- **模块化设计**: 各功能独立管理

## 游戏配置

### 画布设置
- **宽度**: 1440像素
- **高度**: 2560像素
- **FPS**: 60帧/秒
- **背景色**: #0f0f23

### 活动区域限制
- **总宽度**: 1440像素
- **活动区域**: 720像素（居中）
- **左边距**: 360像素
- **右边距**: 1080像素
- **活动范围**: X坐标 360-1080

## 游戏机制

### 主角系统

#### 基本属性
- **尺寸**: 400×600像素
- **初始位置**: X=720, Y=1280（活动区域中央）
- **最大生命值**: 100
- **移动速度**: 780像素/秒（2倍速度）
- **射击间隔**: 1667毫秒（0.6发/秒）
- **子弹伤害**: 10
- **子弹速度**: 2400像素/秒（300%提升）

#### 移动机制
- **水平移动**: 玩家控制（A/D键或左右箭头键）
- **垂直移动**: 自动向上移动（固定速度）
- **边界限制**: 限制在活动区域内（360-1080像素）
- **移动控制**: 遇到边界时停止移动

#### 射击系统
- **自动射击**: 持续自动发射子弹
- **子弹方向**: 固定向上
- **子弹速度**: 不受主角移动影响
- **射程**: 固定，不受相对移动影响

#### 动画系统
- **精灵动画**: 使用4帧循环动画
- **帧文件**: player_walk_01~04.png
- **帧间隔**: 200毫秒
- **方向翻转**: 根据移动方向水平翻转

### 怪物系统

#### 怪物类型

##### 1. BarrelMonster (油桶喷射怪)
- **尺寸**: 300×450像素
- **生命值**: 10（1发子弹击败）
- **伤害**: 20
- **移动速度**: 100像素/秒
- **攻击范围**: 200像素
- **攻击冷却**: 2000毫秒
- **精灵图**: monster_01.png
- **生成概率**: 60%

##### 2. UFOTurret (UFO炮塔)
- **尺寸**: 400×600像素
- **生命值**: 10（1发子弹击败）
- **伤害**: 10
- **移动速度**: 60像素/秒
- **射击间隔**: 1500毫秒（已禁用射击）
- **子弹速度**: 400像素/秒
- **精灵图**: monster_02.png
- **生成概率**: 30%

##### 3. GiantMelee (巨型近战怪)
- **尺寸**: 500×750像素
- **生命值**: 20（2发子弹击败）
- **伤害**: 30
- **移动速度**: 80像素/秒
- **攻击范围**: 250像素
- **攻击冷却**: 3000毫秒
- **精灵图**: monster_03.png
- **生成概率**: 10%

#### 怪物行为
- **完全静止**: 所有怪物完全静止，不移动
- **禁用射击**: UFO炮塔不再发射子弹
- **边界限制**: 限制在活动区域内移动
- **碰撞检测**: 生成时避免彼此重叠，最小50像素间距

### 怪物生成系统

#### 预生成机制
- **预生成**: 游戏开始时预先生成所有怪物
- **生成距离**: 每300像素一个生成点
- **生成数量**: 根据关卡配置动态调整
- **激活条件**: 进入视野范围1.5倍屏幕高度时激活
- **碰撞避免**: 生成时检查彼此间距，最小50像素
- **安全距离**: 前5秒不生成怪物
- **并排限制**: 最多2只怪物并排出现

#### 生成区域
- **水平范围**: 限制在活动区域内（360-1080像素）
- **垂直范围**: 玩家前方800-1200像素
- **类型分布**: 根据关卡配置智能分配

#### 关卡配置驱动
- **配置读取**: 严格遵循关卡配置中的怪物数量限制
- **智能分配**: 根据剩余数量动态调整生成策略
- **难度递增**: 后期关卡增加巨型怪物概率
- **数量控制**: 确保不超过关卡配置的最大数量

### 摄像机系统

#### 摄像机行为
- **水平固定**: 摄像机水平位置固定在屏幕中央
- **垂直跟随**: 摄像机垂直方向跟随主角移动
- **相对静止**: 摄像机与主角保持相对静止
- **边界限制**: 摄像机有合理的移动边界

#### 坐标系统
- **世界坐标**: 游戏对象的世界位置
- **屏幕坐标**: 显示在屏幕上的位置
- **坐标转换**: 摄像机处理世界坐标到屏幕坐标的转换
- **视野裁剪**: 只渲染在摄像机视野内的对象

### 背景系统

#### 背景循环
- **循环方式**: 只在上下方向拼接
- **背景图片**: bg_road_01~05.png
- **关卡组合**: 
  - 关卡1: bg_road_01
  - 关卡2-4: bg_road_02~04循环
  - 关卡5: bg_road_05
- **覆盖范围**: 扩展的摄像机视野

### 音频系统

#### BGM播放
- **音乐文件**: 末日垃圾场.m4a
- **播放时机**: 游戏开始时播放
- **循环播放**: 背景音乐循环播放
- **音量控制**: 可调节音量
- **状态管理**: 暂停/恢复/停止

#### 音频控制
- **开关控制**: 可开启/关闭音频
- **音量滑块**: 实时调节音量
- **状态同步**: 与游戏状态同步

## 关卡系统

### 关卡配置
```javascript
LEVELS: [
    {
        DURATION: 80000,           // 80秒
        ENEMY_SPAWN_MULTIPLIER: 1.0,
        OBSTACLE_SPAWN_MULTIPLIER: 1.0,
        BACKGROUND_COLOR: '#0f0f23',
        MAX_BARREL_MONSTERS: 15,   // 15个油桶怪
        MAX_UFO_TURRETS: 8,        // 8个UFO炮塔
        MAX_GIANT_MELEES: 3,       // 3个巨型怪
        TOTAL_MONSTERS: 26,        // 总怪物数26个
        DIFFICULTY: '简单',
        DESCRIPTION: '新手关卡，怪物较少，节奏较慢'
    },
    {
        DURATION: 120000,          // 120秒
        ENEMY_SPAWN_MULTIPLIER: 1.5,
        OBSTACLE_SPAWN_MULTIPLIER: 1.2,
        BACKGROUND_COLOR: '#1a0f23',
        MAX_BARREL_MONSTERS: 25,   // 25个油桶怪
        MAX_UFO_TURRETS: 15,       // 15个UFO炮塔
        MAX_GIANT_MELEES: 8,       // 8个巨型怪
        TOTAL_MONSTERS: 48,        // 总怪物数48个
        DIFFICULTY: '中等',
        DESCRIPTION: '进阶关卡，怪物增多，节奏加快'
    }
]
```

#### 关卡特点对比
| 关卡 | 时长 | 油桶怪 | UFO炮塔 | 巨型怪 | 总怪物 | 难度 | 描述 |
|------|------|--------|---------|--------|--------|------|------|
| **关卡1** | 80秒 | 15个 | 8个 | 3个 | **26个** | 简单 | 新手关卡，怪物较少，节奏较慢 |
| **关卡2** | 120秒 | 25个 | 15个 | 8个 | **48个** | 中等 | 进阶关卡，怪物增多，节奏加快 |

#### 智能生成策略
- **数量统计**: 实时统计已生成的各类型怪物数量
- **剩余计算**: 根据关卡配置计算剩余可生成数量
- **类型选择**: 基于剩余数量和权重智能选择怪物类型
- **难度递增**: 后期关卡增加巨型怪物生成概率
- **空间优化**: 确保怪物间保持50像素最小间距
- **均匀分布**: 怪物在整个关卡中均匀分布，避免后半段缺失
- **密度控制**: 使用S型曲线控制怪物密度（前期少，中段多，后期最多）

### 关卡进度
- **进度显示**: 实时显示关卡完成百分比
- **进度条**: 动态颜色变化的进度条
- **时间显示**: 显示当前关卡剩余时间
- **完成条件**: 达到关卡时间限制

## 输入系统

### 键盘控制
- **A键/左箭头**: 向左移动
- **D键/右箭头**: 向右移动
- **空格键**: 射击（自动射击，此键预留）

### 触摸控制
- **水平滑动**: 左右移动
- **垂直滑动**: 预留（当前不使用）
- **灵敏度**: 可调节触摸灵敏度

### 鼠标控制
- **水平移动**: 左右移动
- **垂直移动**: 预留（当前不使用）

## UI系统

### 游戏信息显示
- **生命值**: 显示主角当前生命值
- **分数**: 显示当前得分
- **关卡**: 显示当前关卡数
- **时间**: 显示关卡剩余时间
- **进度**: 显示关卡完成百分比

### 音频控制
- **音频开关**: 开启/关闭音频
- **音量滑块**: 调节音量大小
- **状态指示**: 显示音频状态

### 调试信息
- **FPS**: 显示游戏帧率
- **玩家位置**: 显示主角坐标
- **摄像机位置**: 显示摄像机坐标
- **怪物数量**: 显示各类型怪物数量
- **预生成怪物**: 显示预生成怪物数量
- **关卡配置**: 显示当前关卡怪物配置信息
- **生成统计**: 显示怪物生成完成统计

## 碰撞系统

### 碰撞检测
- **AABB碰撞**: 轴对齐包围盒碰撞检测
- **玩家与怪物**: 检测玩家与怪物的碰撞
- **子弹与怪物**: 检测子弹与怪物的碰撞
- **子弹与障碍物**: 检测子弹与障碍物的碰撞

### 伤害系统
- **玩家受伤**: 接触怪物或障碍物时受伤
- **无敌时间**: 受伤后1秒无敌时间
- **怪物死亡**: 生命值归零时死亡
- **分数奖励**: 消灭怪物获得分数

## 粒子系统

### 特效类型
- **爆炸特效**: 怪物死亡时的爆炸效果
- **命中特效**: 子弹命中时的特效
- **粒子数量**: 爆炸15个，命中5个
- **生命周期**: 爆炸1秒，命中0.5秒

## 性能优化

### 渲染优化
- **视野裁剪**: 只渲染可见对象
- **对象池**: 重用游戏对象
- **批量渲染**: 减少绘制调用

### 内存管理
- **对象清理**: 及时清理无效对象
- **资源管理**: 合理管理图片和音频资源
- **垃圾回收**: 避免内存泄漏

## 调试功能

### 调试模式
- **启用方式**: 在config.js中设置DEBUG.ENABLED = true
- **显示内容**: FPS、位置信息、对象数量等
- **调试输出**: 控制台输出详细信息

### 测试工具
- **test_logic.html**: 游戏逻辑测试页面
- **check_images.html**: 图片资源检查工具
- **test_level_config.html**: 关卡配置测试页面
- **test_bullet_monster.html**: 子弹和怪物生成测试
- **test_fixes.html**: 修复验证测试页面
- **code_check.html**: 代码检查工具
- **性能监控**: 实时性能数据

## 开发规范

### 代码结构
- **模块化设计**: 各功能模块独立
- **配置驱动**: 通过配置文件管理参数
- **面向对象**: 使用类和继承
- **事件驱动**: 基于事件的交互

### 命名规范
- **类名**: 大驼峰命名（如GameEngine）
- **方法名**: 小驼峰命名（如updateGame）
- **常量**: 全大写下划线（如CANVAS_WIDTH）
- **变量**: 小驼峰命名（如currentLevel）

## 部署说明

### 运行环境
- **浏览器**: 支持HTML5 Canvas的现代浏览器
- **服务器**: 任意HTTP服务器（推荐使用本地服务器）
- **文件**: 所有文件放在同一目录下

### 启动方式
1. 将所有文件放在同一目录
2. 启动HTTP服务器
3. 在浏览器中访问index.html

### 注意事项
- 需要HTTP服务器运行（不能直接打开HTML文件）
- 确保src文件夹中的美术资源完整
- 检查浏览器控制台是否有错误信息

## 最新更新

### 子弹和怪物系统优化 (v1.0.2)
- **子弹速度提升**: 从800像素/秒提升到2400像素/秒（300%提升）
- **射击频率调整**: 从1发/秒调整为0.6发/秒（更精准的射击节奏）
- **怪物分布修复**: 修复关卡后半段怪物缺失问题，实现全程均匀分布
- **怪物行为优化**: 所有怪物完全静止，UFO炮塔禁用射击
- **关卡重新设计**: 调整关卡时长和怪物数量，优化游戏节奏

#### 主要调整内容
| 项目 | 调整前 | 调整后 | 变化 |
|------|--------|--------|------|
| **子弹速度** | 800像素/秒 | 2400像素/秒 | +300% |
| **射击间隔** | 1000毫秒 | 1667毫秒 | +67% |
| **射击频率** | 1发/秒 | 0.6发/秒 | -40% |
| **怪物分布** | 后半段缺失 | 全程均匀 | 修复 |
| **怪物行为** | 部分移动 | 完全静止 | 优化 |
| **关卡1时长** | 50秒 | 80秒 | +60% |
| **关卡2时长** | 80秒 | 120秒 | +50% |
| **关卡1怪物** | 3个 | 26个 | +767% |
| **关卡2怪物** | 6个 | 48个 | +700% |

### 关卡配置系统修复 (v1.0.1)
- **问题**: 怪物生成系统未使用关卡配置，而是使用固定随机概率
- **修复**: 实现基于关卡配置的智能怪物生成系统
- **改进**:
  - 严格遵循关卡配置中的怪物数量限制
  - 智能分配怪物类型，避免超出配置限制
  - 根据关卡进度调整难度（后期关卡增加巨型怪物概率）
  - 优化怪物间距为50像素，确保不重叠
  - 添加详细的生成统计和调试信息

#### 修复前后对比
| 方面 | 修复前 | 修复后 |
|------|--------|--------|
| **配置使用** | 忽略关卡配置 | 严格遵循关卡配置 |
| **数量控制** | 随机生成，可能超出限制 | 智能控制，不超过配置限制 |
| **类型分配** | 固定概率分布 | 基于剩余数量动态分配 |
| **难度递增** | 无难度递增 | 后期关卡增加巨型怪物概率 |
| **调试信息** | 基础信息 | 详细的生成统计信息 |

## 版本历史

### v1.0.2 (当前版本)
- ✅ 子弹速度提升300%（800→2400像素/秒）
- ✅ 射击频率调整（1发/秒→0.6发/秒）
- ✅ 怪物分布修复（全程均匀分布）
- ✅ 怪物完全静止（禁用所有移动）
- ✅ UFO炮塔禁用射击
- ✅ 关卡重新设计（80秒/120秒，26/48个怪物）
- ✅ 怪物间距优化（50像素）
- ✅ 安全距离设置（前5秒无怪物）
- ✅ 并排怪物限制（最多2只）

### v1.0.1
- ✅ 关卡配置驱动生成系统
- ✅ 智能怪物类型选择
- ✅ 怪物间距优化（100像素）
- ✅ 远程怪物视野限制射击

### v1.0.0
- ✅ 基础游戏框架
- ✅ 主角移动和射击系统
- ✅ 三种怪物类型
- ✅ 摄像机跟随系统
- ✅ 背景循环系统
- ✅ 音频播放系统
- ✅ 预生成怪物系统
- ✅ 活动区域限制
- ✅ 碰撞检测系统
- ✅ UI和调试系统

## 已知问题

### 当前限制
- 怪物类型相对简单
- 关卡数量有限（目前2个关卡）
- 音效系统待完善
- 移动端适配待优化

### 待优化项目
- 增加更多怪物类型
- 添加道具系统
- 完善音效系统
- 优化移动端体验
- 添加更多关卡
- 增加关卡间的过渡动画
- 添加成就系统

## 联系方式

如有问题或建议，请通过以下方式联系：
- 项目仓库: [GitHub链接]
- 问题反馈: [Issues链接]
- 技术讨论: [Discussions链接]

---

**注意**: 本文档会随着游戏开发进度持续更新，请定期查看最新版本。